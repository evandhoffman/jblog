---
title: Using OpenSWAN to connect two VPCs in different AWS regions
author: Evan Hoffman
layout: post
permalink: /2014/08/07/using-openswan-to-connect-two-vpcs-in-different-aws-regions/
dsq_thread_id:
  - 2954013492
categories:
  - Uncategorized
tags:
  - amazon
  - aws
  - ipsec
  - linux
  - mtu
  - openswan
  - ubuntu
  - vpc
---
Amazon has a pretty decent writeup on how to do this (<a href="https://aws.amazon.com/articles/5472675506466066" onclick="_gaq.push(['_trackEvent', 'outbound-article', 'https://aws.amazon.com/articles/5472675506466066', 'here']);" >here</a>), but in trying to establish Postgres replication across regions, I found some weird behavior where I could connect to the port directly (telnet to 5432) but psql (or pg_basebackup) didn&#8217;t work. tcpdump showed this:

<div class="wp_syntax">
  <table>
    <tr>
      <td class="code">
        <pre class="bash" style="font-family:monospace;"><span style="color: #000000;">16</span>:<span style="color: #000000;">11</span>:<span style="color: #000000;">28.419642</span> IP 10.121.11.47.35039 <span style="color: #000000; font-weight: bold;">&gt;</span> 10.1.11.254.postgresql: Flags <span style="color: #7a0874; font-weight: bold;">&#91;</span>P.<span style="color: #7a0874; font-weight: bold;">&#93;</span>, <span style="color: #c20cb9; font-weight: bold;">seq</span> <span style="color: #000000;">9</span>:<span style="color: #000000;">234</span>, ack <span style="color: #000000;">2</span>, win <span style="color: #000000;">211</span>, options <span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #c20cb9; font-weight: bold;">nop</span>,<span style="color: #c20cb9; font-weight: bold;">nop</span>,TS val <span style="color: #000000;">11065893</span> ecr <span style="color: #000000;">1811434</span><span style="color: #7a0874; font-weight: bold;">&#93;</span>, length <span style="color: #000000;">225</span>
<span style="color: #000000;">16</span>:<span style="color: #000000;">11</span>:<span style="color: #000000;">28.419701</span> IP 10.121.11.47.35039 <span style="color: #000000; font-weight: bold;">&gt;</span> 10.1.11.254.postgresql: Flags <span style="color: #7a0874; font-weight: bold;">&#91;</span>P.<span style="color: #7a0874; font-weight: bold;">&#93;</span>, <span style="color: #c20cb9; font-weight: bold;">seq</span> <span style="color: #000000;">9</span>:<span style="color: #000000;">234</span>, ack <span style="color: #000000;">2</span>, win <span style="color: #000000;">211</span>, options <span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #c20cb9; font-weight: bold;">nop</span>,<span style="color: #c20cb9; font-weight: bold;">nop</span>,TS val <span style="color: #000000;">11065893</span> ecr <span style="color: #000000;">1811434</span><span style="color: #7a0874; font-weight: bold;">&#93;</span>, length <span style="color: #000000;">225</span>
<span style="color: #000000;">16</span>:<span style="color: #000000;">11</span>:<span style="color: #000000;">28.421186</span> IP 10.1.11.254.postgresql <span style="color: #000000; font-weight: bold;">&gt;</span> 10.121.11.47.35039: Flags <span style="color: #7a0874; font-weight: bold;">&#91;</span>.<span style="color: #7a0874; font-weight: bold;">&#93;</span>, ack <span style="color: #000000;">234</span>, win <span style="color: #000000;">219</span>, options <span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #c20cb9; font-weight: bold;">nop</span>,<span style="color: #c20cb9; font-weight: bold;">nop</span>,TS val <span style="color: #000000;">1811520</span> ecr <span style="color: #000000;">11065893</span>,<span style="color: #c20cb9; font-weight: bold;">nop</span>,<span style="color: #c20cb9; font-weight: bold;">nop</span>,sack <span style="color: #000000;">1</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span><span style="color: #000000;">9</span>:<span style="color: #000000;">234</span><span style="color: #7a0874; font-weight: bold;">&#125;</span><span style="color: #7a0874; font-weight: bold;">&#93;</span>, length <span style="color: #000000;"></span>
<span style="color: #000000;">16</span>:<span style="color: #000000;">11</span>:<span style="color: #000000;">28.425273</span> IP 10.1.11.254.postgresql <span style="color: #000000; font-weight: bold;">&gt;</span> 10.121.11.47.35039: Flags <span style="color: #7a0874; font-weight: bold;">&#91;</span>P.<span style="color: #7a0874; font-weight: bold;">&#93;</span>, <span style="color: #c20cb9; font-weight: bold;">seq</span> <span style="color: #000000;">2</span>:<span style="color: #000000;">1377</span>, ack <span style="color: #000000;">234</span>, win <span style="color: #000000;">219</span>, options <span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #c20cb9; font-weight: bold;">nop</span>,<span style="color: #c20cb9; font-weight: bold;">nop</span>,TS val <span style="color: #000000;">1811522</span> ecr <span style="color: #000000;">11065893</span><span style="color: #7a0874; font-weight: bold;">&#93;</span>, length <span style="color: #000000;">1375</span>
<span style="color: #000000;">16</span>:<span style="color: #000000;">11</span>:<span style="color: #000000;">28.425291</span> IP 10.1.96.20 <span style="color: #000000; font-weight: bold;">&gt;</span> 10.1.11.254: ICMP 10.121.11.47 unreachable - need to frag <span style="color: #7a0874; font-weight: bold;">&#40;</span>mtu <span style="color: #000000;">1422</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>, length <span style="color: #000000;">556</span>
<span style="color: #000000;">16</span>:<span style="color: #000000;">11</span>:<span style="color: #000000;">28.697397</span> IP 10.1.11.254.postgresql <span style="color: #000000; font-weight: bold;">&gt;</span> 10.121.11.47.35039: Flags <span style="color: #7a0874; font-weight: bold;">&#91;</span>P.<span style="color: #7a0874; font-weight: bold;">&#93;</span>, <span style="color: #c20cb9; font-weight: bold;">seq</span> <span style="color: #000000;">2</span>:<span style="color: #000000;">1377</span>, ack <span style="color: #000000;">234</span>, win <span style="color: #000000;">219</span>, options <span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #c20cb9; font-weight: bold;">nop</span>,<span style="color: #c20cb9; font-weight: bold;">nop</span>,TS val <span style="color: #000000;">1811590</span> ecr <span style="color: #000000;">11065893</span><span style="color: #7a0874; font-weight: bold;">&#93;</span>, length <span style="color: #000000;">1375</span>
<span style="color: #000000;">16</span>:<span style="color: #000000;">11</span>:<span style="color: #000000;">28.697438</span> IP 10.1.96.20 <span style="color: #000000; font-weight: bold;">&gt;</span> 10.1.11.254: ICMP 10.121.11.47 unreachable - need to frag <span style="color: #7a0874; font-weight: bold;">&#40;</span>mtu <span style="color: #000000;">1422</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>, length <span style="color: #000000;">556</span>
<span style="color: #000000;">16</span>:<span style="color: #000000;">11</span>:<span style="color: #000000;">29.241311</span> IP 10.1.11.254.postgresql <span style="color: #000000; font-weight: bold;">&gt;</span> 10.121.11.47.35039: Flags <span style="color: #7a0874; font-weight: bold;">&#91;</span>P.<span style="color: #7a0874; font-weight: bold;">&#93;</span>, <span style="color: #c20cb9; font-weight: bold;">seq</span> <span style="color: #000000;">2</span>:<span style="color: #000000;">1377</span>, ack <span style="color: #000000;">234</span>, win <span style="color: #000000;">219</span>, options <span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #c20cb9; font-weight: bold;">nop</span>,<span style="color: #c20cb9; font-weight: bold;">nop</span>,TS val <span style="color: #000000;">1811726</span> ecr <span style="color: #000000;">11065893</span><span style="color: #7a0874; font-weight: bold;">&#93;</span>, length <span style="color: #000000;">1375</span>
<span style="color: #000000;">16</span>:<span style="color: #000000;">11</span>:<span style="color: #000000;">29.241356</span> IP 10.1.96.20 <span style="color: #000000; font-weight: bold;">&gt;</span> 10.1.11.254: ICMP 10.121.11.47 unreachable - need to frag <span style="color: #7a0874; font-weight: bold;">&#40;</span>mtu <span style="color: #000000;">1422</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>, length <span style="color: #000000;">556</span>
<span style="color: #000000;">16</span>:<span style="color: #000000;">11</span>:<span style="color: #000000;">30.333438</span> IP 10.1.11.254.postgresql <span style="color: #000000; font-weight: bold;">&gt;</span> 10.121.11.47.35039: Flags <span style="color: #7a0874; font-weight: bold;">&#91;</span>P.<span style="color: #7a0874; font-weight: bold;">&#93;</span>, <span style="color: #c20cb9; font-weight: bold;">seq</span> <span style="color: #000000;">2</span>:<span style="color: #000000;">1377</span>, ack <span style="color: #000000;">234</span>, win <span style="color: #000000;">219</span>, options <span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #c20cb9; font-weight: bold;">nop</span>,<span style="color: #c20cb9; font-weight: bold;">nop</span>,TS val <span style="color: #000000;">1811999</span> ecr <span style="color: #000000;">11065893</span><span style="color: #7a0874; font-weight: bold;">&#93;</span>, length <span style="color: #000000;">1375</span>
<span style="color: #000000;">16</span>:<span style="color: #000000;">11</span>:<span style="color: #000000;">30.333488</span> IP 10.1.96.20 <span style="color: #000000; font-weight: bold;">&gt;</span> 10.1.11.254: ICMP 10.121.11.47 unreachable - need to frag <span style="color: #7a0874; font-weight: bold;">&#40;</span>mtu <span style="color: #000000;">1422</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>, length <span style="color: #000000;">556</span>
<span style="color: #000000;">16</span>:<span style="color: #000000;">11</span>:<span style="color: #000000;">32.513418</span> IP 10.1.11.254.postgresql <span style="color: #000000; font-weight: bold;">&gt;</span> 10.121.11.47.35039: Flags <span style="color: #7a0874; font-weight: bold;">&#91;</span>P.<span style="color: #7a0874; font-weight: bold;">&#93;</span>, <span style="color: #c20cb9; font-weight: bold;">seq</span> <span style="color: #000000;">2</span>:<span style="color: #000000;">1377</span>, ack <span style="color: #000000;">234</span>, win <span style="color: #000000;">219</span>, options <span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #c20cb9; font-weight: bold;">nop</span>,<span style="color: #c20cb9; font-weight: bold;">nop</span>,TS val <span style="color: #000000;">1812544</span> ecr <span style="color: #000000;">11065893</span><span style="color: #7a0874; font-weight: bold;">&#93;</span>, length <span style="color: #000000;">1375</span>
<span style="color: #000000;">16</span>:<span style="color: #000000;">11</span>:<span style="color: #000000;">32.513467</span> IP 10.1.96.20 <span style="color: #000000; font-weight: bold;">&gt;</span> 10.1.11.254: ICMP 10.121.11.47 unreachable - need to frag <span style="color: #7a0874; font-weight: bold;">&#40;</span>mtu <span style="color: #000000;">1422</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>, length <span style="color: #000000;">556</span>
<span style="color: #000000;">16</span>:<span style="color: #000000;">11</span>:<span style="color: #000000;">36.881409</span> IP 10.1.11.254.postgresql <span style="color: #000000; font-weight: bold;">&gt;</span> 10.121.11.47.35039: Flags <span style="color: #7a0874; font-weight: bold;">&#91;</span>P.<span style="color: #7a0874; font-weight: bold;">&#93;</span>, <span style="color: #c20cb9; font-weight: bold;">seq</span> <span style="color: #000000;">2</span>:<span style="color: #000000;">1377</span>, ack <span style="color: #000000;">234</span>, win <span style="color: #000000;">219</span>, options <span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #c20cb9; font-weight: bold;">nop</span>,<span style="color: #c20cb9; font-weight: bold;">nop</span>,TS val <span style="color: #000000;">1813636</span> ecr <span style="color: #000000;">11065893</span><span style="color: #7a0874; font-weight: bold;">&#93;</span>, length <span style="color: #000000;">1375</span>
<span style="color: #000000;">16</span>:<span style="color: #000000;">11</span>:<span style="color: #000000;">36.881460</span> IP 10.1.96.20 <span style="color: #000000; font-weight: bold;">&gt;</span> 10.1.11.254: ICMP 10.121.11.47 unreachable - need to frag <span style="color: #7a0874; font-weight: bold;">&#40;</span>mtu <span style="color: #000000;">1422</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>, length <span style="color: #000000;">556</span></pre>
      </td>
    </tr>
  </table>
</div>

After quite a bit of Google and mucking in network ACLs and security groups, the fix ended up being this:

<div class="wp_syntax">
  <table>
    <tr>
      <td class="code">
        <pre class="bash" style="font-family:monospace;">iptables <span style="color: #660033;">-A</span> FORWARD <span style="color: #660033;">-p</span> tcp <span style="color: #660033;">--tcp-flags</span> SYN,RST SYN <span style="color: #660033;">-j</span> TCPMSS <span style="color: #660033;">--clamp-mss-to-pmtu</span>
iptables <span style="color: #660033;">-A</span> FORWARD <span style="color: #660033;">-p</span> tcp <span style="color: #660033;">--tcp-flags</span> SYN,RST SYN <span style="color: #660033;">-j</span> TCPMSS <span style="color: #660033;">--set-mss</span> <span style="color: #000000;">1500</span></pre>
      </td>
    </tr>
  </table>
</div>

(The above two commands need to be run on both OpenSwan boxes.)